#!/bin/bash
set -euo pipefail
. L_lib.sh L_argparse \
	-- -n eval=L_dryrun=1 \
	-- file type=file_r \
	---- "$@"
timestamp=$(date +%Y-%m-%dT%H:%M:%S+%Z)
L_path_dirname -v dir "$file"
L_path_basename -v file "$file"
destf="$dir/.$file.backup.$timestamp.${file##*.}"
linkf="$dir/.$file.backup.${file##*.}"
if [[ -e "$destf" ]]; then
	L_fatal "Destination $destf exists"
fi
if [[ -e "$linkf" && ! -L "$linkf" ]]; then
	L_fatal "Link destination $linkf exists and is not a symlink"
fi
L_run cp -r "$1" "$destf"
L_run ln -vsfT "$destf" "$linkf"
