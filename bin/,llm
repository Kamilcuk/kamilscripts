#!/bin/bash
set -euo pipefail

makefile() {
    local path=$1
    if mkdir -p "$(dirname -- "$path")"; then
        touch "$path"
    fi
}

bwrap_sandbox() {
    local cachedir="${XDG_CACHE_HOME:-$HOME/.cache}/,llm"
    local root="$cachedir/root"
    mkdir -p "$root/$HOME"
    #
    local args=(
        --bind "$cachedir"/root /
        --setenv KCLLM 1
        --unshare-all
        --share-net
        --die-with-parent
        --bind "$PWD" "$PWD"
        --chdir "$PWD"
        # --setenv HOME "$HOME"
        # --setenv PATH "$PATH"
        --tmpfs /tmp
        --proc /proc
        --dev /dev
    )
    add() { args+=("$@"); }
    addpath() {
        local i
        for i in "${@:2}"; do
            if [[ -e "$i" ]]; then
                args+=("$1" "$i" "$i")
            fi
        done
    }
    local cache=${XDG_CACHE_HOME:-$HOME/.cache}
    local config=${XDG_CONFIG_HOME:-$HOME/.config}
    # basic directories we need.
    addpath --ro-bind /bin /usr /lib /lib64 /etc /opt /run/systemd
    addpath --bind /run/user /sys
    # cache list to consider
    addpath --bind "$cache/uv" "$HOME/.local/share/uv"
    addpath --bind "$cache/pip"
    addpath --bind "$cache/npm" "$cache/pnpm" "$cache/yarn"
    addpath --bind "$cache/poetry" "$cache/maturin" "$cache/go-build"
    addpath --bind "$HOME/.npm" "$HOME/.node_modules"
    addpath --ro-bind "$config/yarn" "$config/npm"
    addpath --bind "$HOME/.cargo" "$HOME/.rustup"
    addpath --ro-bind "$HOME/.gitconfig" "$config/git/config"
    addpath --ro-bind /opt /snap "$HOME/snap"
    addpath --ro-bind /nix "$HOME"/.local/state/nix "$HOME/.nix-profile" "$HOME/.nix-defexpr"
    # /nix/var/nix/daemon-socket
    addpath --bind "$HOME/.dotnet" "$HOME/.nuget"
    if [[ -L /etc/resolv.conf ]]; then
        local tmp
        tmp="$(readlink -f /etc/resolv.conf)"
        addpath --ro-bind "$tmp"
    fi
    # gemini, crush, opencode configuration directories.
    for i in gemini crush opencode claude; do
        addpath --bind "$cache/$i" "$config/$i" "$HOME/.$i"
    done
    # Podman.
    if ((arg_podman)); then
        if [[ -e /usr/bin/docker ]] && [[ -e /usr/bin/podman ]] && /usr/bin/podman --version >/dev/null 2>/dev/null; then
            L_debug "Using podman..."
            # Start podman service sock.
            if [[ ! -e /run/user/$UID/podman/podman.sock ]] && L_hash systemctl; then
                L_logrun systemctl start --user podman.service
            fi
            # Add environment variables.
            add --setenv CONTAINER_RUNTIME podman
            add --setenv DOCKER_BIN podman
            # Set the podman socket. the socket.
            add --ro-bind /run/user/$UID/podman /run/user/$UID/podman
            add --setenv DOCKER_HOST unix:///run/user/$UID/podman/podman.sock
            # Create /llmbin directory with podman wrapper that will explicitly pass --url.
            local fd
            exec {fd}< <(printf "%s\n" '#!/bin/bash' 'exec /usr/bin/podman --url "${DOCKER_HOST:-unix:///run/user/$UID/podman/podman.sock}" "$@"')
            add --perms 555 --file "$fd" /llmbin/podman --symlink /llmbin/podman /llmbin/docker
            export PATH="/llmbin:$PATH"
        else
            L_fatal "Podman not detected"
        fi
    fi
    if false; then
        # Add bash history
        # Don't add - it is security issue.
        for i in "$HOME/.bash_history"; do
            makefile "$root/$i"
            add --bind "$root/$i" "$i"
        done
        if [[ -n "${HISTFILE:-}" && -e "$HISTFILE" && "$HISTFILE" != "$HOME/.bash_history" ]]; then
            makefile "$root/$HISTFILE"
            add --bind "$root/$HISTFILE" "$HISTFILE"
        fi
    fi
    # Hide
    shopt -s globstar nullglob extglob
    for i in "$PWD"/{,**/}{env*,.env*,secrets*,*.pem,*.key,*.crt} "${arg_hide[@]}"; do
        if [[ -e "$i" ]]; then
            i=$(readlink -f "$i")
            L_debug "Hiding $i"
            add --ro-bind /dev/null "$i"
        fi
    done
    # Add args
    addpath --ro-bind "${arg_ro[@]}"
    addpath --bind "${arg_rw[@]}"
    # Disabled adding env variables. They are just inherited.
    if false; then
        list=(PATH HOME USER LOGNAME SHELL
                    HTTP_PROXY HTTPS_PROXY NO_PROXY
                    GEMINI_API_KEY GEMINI_SECRET GEMINI_ENDPOINT
                    PYTHONPATH VIRTUAL_ENV NVM_DIR NODE_PATH
                    XDG_CACHE_HOME XDG_CONFIG_HOME TERM)
        for i in "${list[@]}"; do
            if [[ -n "${!i:-}" ]]; then
                add --setenv "$i" "${!i}"
            fi
        done
    fi
    #
    if ((arg_verbose)); then
        set -x
    fi
    exec bwrap "${args[@]}" "$@"
}

add_ro_if_not_there() {
    if ! L_args_contain ~/.node_modules "${arg_ro[@]}" "${arg_rw[@]}"; then
        arg_ro+=(~/.node_modules)
    fi
}

C_gemini() {
    if [[ $(which gemini) == ~/.node_modules/bin/gemini ]]; then
        add_ro_if_not_there ~/.node_modules
    fi
    bwrap_sandbox \
        env GEMINI_TIMEOUT=999999 \
        gemini --yolo "$@"
}

C_bwrap() {
    if ((!$#)); then
        set -- bash -l
    fi
    bwrap_sandbox "$@"
}

C_sandbox() { C_bwrap "$@"; }
C_bash() { C_bwrap bash "$@"; }
C_crush() {
    if [[ "$(which crush)" == ~/go/bin/crush ]]; then
        add_ro_if_not_there ~/go
    fi
    C_bwrap crush --yolo "$@"
}
C_opencode() { C_bwrap opencode --agent yolo "$@"; }

rotate_key() {
    local arg_key=$1
    if [[ arg_key != 0 ]]; then
        local v=GEMINI_API_KEY$arg_key
        if [[ -v $v ]]; then
            L_warning "+ export GEMINI_API_KEY=\$$v"
            L_notice "GEMINI_API_KEY=$GEMINI_API_KEY arg_key=$arg_key"
            export GEMINI_API_KEY=${!v}
        else
            L_warning "--key argument invalid, variable does not exist: $v"
        fi
    fi
}

. L_lib.sh -s
arg_verbose=0
L_argparse dest_prefix=arg_ \
    -- -q --quiet nargs=0 eval='((arg_verbose--)); L_log_level_dec' \
    -- -v --verbose nargs=0 eval='((arg_verbose++)); L_log_level_inc' \
    -- --ro action=append default= help="List of directories or file to mount read only" \
    -- --rw --bind action=append default= help="List of directories or files to mount read write" \
    -- --hide action=append default= help="Hide specific files from the llm by mounting /dev/null on top of them" \
    -- -k --key default= nargs=1 eval='rotate_key "$@"' \
    -- --podman flag=1 \
    -- call=function prefix=C_ \
    ---- "$@"
