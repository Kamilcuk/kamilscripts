#!/bin/bash
set -euo pipefail

bwrap_sandbox() {
    local cachedir="${XDG_CACHE_HOME:-$HOME/.cache}/,llm"
    local root="$cachedir/root"
    mkdir -p "$root/$HOME"
    #
    local args=(
        --bind "$cachedir"/root /
        --setenv KCLLM 1
        --unshare-all
        --share-net
        --die-with-parent
        --bind "$PWD" "$PWD"
        --chdir "$PWD"
        # --setenv HOME "$HOME"
        # --setenv PATH "$PATH"
        --tmpfs /tmp
        --proc /proc
        --dev /dev
    )
    add() { args+=("$@"); }
    adddir() {
        local i
        for i in "${@:2}"; do
            if [[ -e "$i" ]]; then
                args+=("$1" "$i" "$i")
            fi
        done
    }
    local cache=${XDG_CACHE_HOME:-$HOME/.cache}
    local config=${XDG_CONFIG_HOME:-$HOME/.config}
    # basic directories we need.
    adddir --ro-bind /bin /usr /lib /lib64 /etc /opt /run/systemd
    adddir --bind /run/user /sys
    # cache list to consider
    adddir --bind "$cache/uv" "$HOME/.local/share/uv"
    adddir --bind "$cache/pip"
    adddir --bind "$cache/npm" "$cache/pnpm" "$cache/yarn"
    adddir --bind "$cache/poetry" "$cache/maturin" "$cache/go-build"
    adddir --ro-bind "$config/npm"
    adddir --bind "$HOME/.npm"
    adddir --bind "$HOME/.cargo" "$HOME/.rustup"
    adddir --bind "$config/yarn"
    adddir --ro-bind "$HOME/.gitconfig" "$config/git/config"
    # Gemini configuration directories.
    adddir --bind "$cache/gemini" "$config/gemini" "$HOME/.gemini"
    # Podman.
    if ((config_podman)); then
        if [[ -e /usr/bin/docker ]] && [[ -e /usr/bin/podman ]] && /usr/bin/podman --version >/dev/null 2>/dev/null; then
            # Start podman service sock.
            if L_hash systemctl; then
                if ! systemctl is-active --user podman.service; then
                    L_logrun systemctl start --user podman.service
                fi
            fi
            # Add environment variables.
            add --setenv CONTAINER_RUNTIME podman
            add --setenv DOCKER_BIN podman
            # Set the podman socket. the socket.
            add --ro-bind /run/user/$UID/podman /run/user/$UID/podman
            add --setenv DOCKER_HOST unix:///run/user/$UID/podman/podman.sock
            # Create /llmbin directory with podman wrapper that will explicitly pass --url.
            local fd
            exec {fd}< <(printf "%s\n" '#!/bin/bash' 'exec /usr/bin/podman --url "${DOCKER_HOST:-unix:///run/user/$UID/podman/podman.sock}" "$@"')
            add --perms 555 --file "$fd" /llmbin/podman --symlink /llmbin/podman /llmbin/docker
            export PATH="/llmbin:$PATH"
        fi
    fi
    # Add bash history
    for i in "$HOME/.bash_history"; do
        touch "$root/$i"
        add --bind "$root/$i" "$i"
    done
    if [[ -n "${HISTFILE:-}" && -e "$HISTFILE" && "$HISTFILE" != "$HOME/.bash_history" ]]; then
        add --bind "$root/$HISTFILE" "$HISTFILE"
    fi
    # Disabled adding env variables. They are just inherited.
    if false; then
        list=(PATH HOME USER LOGNAME SHELL
                    HTTP_PROXY HTTPS_PROXY NO_PROXY
                    GEMINI_API_KEY GEMINI_SECRET GEMINI_ENDPOINT
                    PYTHONPATH VIRTUAL_ENV NVM_DIR NODE_PATH
                    XDG_CACHE_HOME XDG_CONFIG_HOME TERM)
        for i in "${list[@]}"; do
            if [[ -n "${!i:-}" ]]; then
                add --setenv "$i" "${!i}"
            fi
        done
    fi
    #
    set -x
    exec bwrap "${args[@]}" "$@"
}

C_gemini() {
    bwrap_sandbox \
        env GEMINI_TIMEOUT=999999 \
        gemini --yolo "$@"
}

C_bwrap() {
    if ((!$#)); then
        set -- bash -l
    fi
    bwrap_sandbox "$@"
}

C_sandbox() { C_bwrap "$@"; }
C_bash() { C_bwrap bash "$@"; }

. L_lib.sh
L_argparse \
    -- --podman flag=1 dest=config_podman \
    -- call=function prefix=C_ \
    ---- "$@"
