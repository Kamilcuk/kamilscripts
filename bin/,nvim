#!/usr/bin/bash
set -euo pipefail

# Directory with all our data.
dir=~/.cache/,nvim
# Directory with cloned neovim repository.
builddir="$dir"/neovim
# Installation directory where CMake installs neovim.
installdir="$dir"/install
# Installed nvim executable location inside installation directory.
installnvim="$installdir"/bin/nvim

r() {
	echo "+ $*" >&2
	"$@"
}

build() {
	,nice -p $$
	# Clone, build and install neovim repository.
	if [[ ! -e "$builddir" ]]; then
		r mkdir -vp "$builddir"
		r git clone https://github.com/neovim/neovim.git "$builddir"
	fi
	if [[ -x "$installnvim" && -e "$builddir/runtime" ]]; then
		oldversion=$(env VIM="$installdir/share/nvim/runtime" "$installnvim" -V1 -v) || true
	else
		oldversion=system
	fi
	r git -C "$builddir" tag -d nightly stable
	r git -C "$builddir" fetch --all --tags --prune
	r git -C "$builddir" checkout tags/nightly
	r rm -vf "$builddir"/build/.ran-cmake
	r make -C "$builddir" CMAKE_BUILD_TYPE=RelWithDebInfo VERBOSE=1 CMAKE_INSTALL_PREFIX="$installdir" \
		cmake nvim install
	#
	newversion=$("$installnvim" -V1 -v)
	{
		echo '--- new version ---'
		echo "$newversion"
	} | r sdiff <(
		echo '--- old version ---'
		cat <<<"$oldversion"
	) - || true
	#
	# Create a symlink to this script to run nvim with set VIM runtime.
	r mkdir -vp ~/.local/bin
	r ln -svf "$installnvim" ~/.local/bin/nvim
	echo SUCCESS
}

_nvim() {
	if [[ -x "$installnvim" && -e "$builddir/runtime" ]]; then
		exec env VIM="$installdir/share/nvim/runtime" "$installnvim" "$@"
	elif hash nvim 2>/dev/null; then
		exec nvim "$@"
	elif hash vim 2>/dev/null; then
		exec vim "$@"
	elif hash vi 2>/dev/null; then
		exec vi "$@"
	fi
}

if (($# == 1)); then
	case "$1" in
	-h | --help)
		echo "Usage: ,nvim [-h|--help|--build]"
		echo
		;;
	--build)
		build
		exit
		;;
	esac
fi

_nvim "$@"
